<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <title>I/E Reaction Test (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #0b1220;
      --secondary: #111a2c;
      --accent: #2a395a;
      --text: #eaf0ff;
      --muted: #98a8c9;
      --success: #5de4a9;
      --danger: #ff8b8b;
      --warning: #ffca7a;
    }

    * {
      box-sizing: border-box;
      transition: all 0.2s ease;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100svh;
      margin: 0;
      background: linear-gradient(135deg, var(--primary) 0%, #1a2a4f 100%);
      color: var(--text);
      line-height: 1.6;
    }

    .card {
      width: min(720px, 92vw);
      background: var(--secondary);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(42, 57, 90, 0.3);
    }

    h1 {
      margin: 0 0 8px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--text) 0%, var(--muted) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
    }

    .subtitle {
      color: var(--muted);
      font-size: 16px;
      margin-bottom: 24px;
      text-align: center;
    }

    .word {
      font-size: clamp(32px, 7vw, 56px);
      text-align: center;
      padding: 40px 0;
      letter-spacing: .5px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--text) 0%, var(--muted) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      min-height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .row {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      font-size: 18px;
      padding: 16px 24px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--accent) 0%, #1c2a48 100%);
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      flex: 1;
      min-width: 140px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    #btnI {
      background: linear-gradient(135deg, var(--success) 0%, #4ac295 100%);
    }

    #btnE {
      background: linear-gradient(135deg, var(--danger) 0%, #e57373 100%);
    }

    .pill {
      font-size: 14px;
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill span {
      font-weight: 600;
      color: var(--text);
    }

    .ok { color: var(--success); }
    .bad { color: var(--danger); }
    .warn { color: var(--warning); }

    .hidden { display: none; }

    textarea, input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--accent);
      background: rgba(15, 24, 48, 0.6);
      color: var(--text);
      font-size: 16px;
    }

    textarea:focus, input:focus {
      outline: none;
      border-color: #3a4d7a;
      box-shadow: 0 0 0 2px rgba(58, 77, 122, 0.3);
    }

    .small {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 6px;
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .section {
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(42, 57, 90, 0.3);
    }

    .section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .progress-bar {
      height: 8px;
      background: rgba(42, 57, 90, 0.3);
      border-radius: 4px;
      margin: 16px 0;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--success) 0%, #4ac295 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .instructions {
      background: rgba(42, 57, 90, 0.2);
      padding: 16px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid var(--accent);
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(42, 57, 90, 0.2);
    }

    .result-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .result-value {
      font-weight: 600;
    }

    .auto-email-info {
      background: rgba(93, 228, 169, 0.1);
      border: 1px solid rgba(93, 228, 169, 0.3);
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
      color: var(--success);
    }

    @media (max-width: 640px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .card {
        padding: 24px 20px;
      }

      button {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>I / E Reaction Test</h1>
    <div class="subtitle">“Æ–≥ –≥–∞—Ä—á –∏—Ä—ç—Ö –±“Ø—Ä—Ç "I" (—ç–µ—Ä—ç–≥) —ç—Å–≤—ç–ª "E" (—Å”©—Ä”©–≥)-–≥ –¥–∞—Ä–Ω–∞. –•—ç—Ç —Ö—É—Ä–¥–∞–Ω –¥–∞—Ä–∞–ª—Ç (<200ms) –±–æ–ª —Ç–æ–æ—Ü–æ—Ö–≥“Ø–π.</div>

    <div id="setup">
      <div class="section">
        <div class="grid">
          <div>
            <label class="small">–û—Ä–æ–ª—Ü–æ–≥—á–∏–π–Ω ID / –ù—ç—Ä (–∑–∞–∞–≤–∞–ª):</label>
            <input id="participant" placeholder="–ñ–∏—à—ç—ç: –ë.–ë–∞—Ç–±–∞—è—Ä" required>
          </div>
          <div>
            <label class="small">Anti-spam –±–æ—Å–≥–æ (ms):</label>
            <input id="minRt" type="number" value="200">
            <div class="small">–•–∞—Ä–∏—É–ª—Ç—ã–Ω –¥–æ–æ–¥ —Ö—É–≥–∞—Ü–∞–∞. –ñ–∏—à—ç—ç –Ω—å: 200</div>
          </div>
        </div>
      </div>

      <div class="auto-email-info">
        <strong>üìß –ê–≤—Ç–æ–º–∞—Ç –∏–º—ç–π–ª:</strong> –¢—É—Ä—à–∏–ª—Ç –¥—É—É—Å—Å–∞–Ω—ã –¥–∞—Ä–∞–∞ “Ø—Ä –¥“Ø–Ω –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä amarmarker@gmail.com —Ö–∞—è–≥—Ç –∏–ª–≥—ç—ç–≥–¥—ç–Ω—ç.
      </div>

      <div class="instructions">
        <strong>–ó–∞–∞–≤–∞—Ä:</strong>
        <ul style="margin: 8px 0; padding-left: 20px;">
          <li>–î—ç–ª–≥—ç—Ü—ç–Ω –¥—ç—ç—Ä –≥–∞—Ä—á –∏—Ä—ç—Ö “Ø–≥ –±“Ø—Ä—Ç —Ö—É—Ä–¥–∞–Ω —Ö–∞—Ä–∏—É–ª–∞—Ö</li>
          <li>"I" —Ç–æ–≤—á - —ç–µ—Ä—ç–≥ —Å—ç—Ç–≥—ç–≥–¥—ç–ª —Ç”©—Ä“Ø“Ø–ª—Å—ç–Ω “Ø–≥</li>
          <li>"E" —Ç–æ–≤—á - —Å”©—Ä”©–≥ —Å—ç—Ç–≥—ç–≥–¥—ç–ª —Ç”©—Ä“Ø“Ø–ª—Å—ç–Ω “Ø–≥</li>
          <li>–•—ç—Ç —Ö—É—Ä–¥–∞–Ω —Ö–∞—Ä–∏—É–ª—Ç—ã–≥ (200ms-—ç—ç—Å –±–∞–≥–∞) —Ç–æ–æ—Ü–æ—Ö–≥“Ø–π</li>
          <li>–ê–ª—å –±–æ–ª–æ—Ö —Ö—É—Ä–¥–∞–Ω, –∑”©–≤ —Ö–∞—Ä–∏—É–ª–∞—Ö—ã–≥ —Ö–∏—á—ç—ç–≥—ç—ç—Ä—ç–π</li>
        </ul>
      </div>

      <div class="row">
        <button id="btnStart">–¢—É—Ä—à–∏–ª—Ç—ã–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö</button>
      </div>
    </div>

    <div id="stage" class="hidden">
      <div class="section">
        <div class="row">
          <div class="pill">“Æ–≥: <span id="idx">0</span>/<span id="total">0</span></div>
          <div class="pill">–•“Ø—á–∏–Ω—Ç—ç–π: <span id="validCount" class="ok">0</span></div>
          <div class="pill">–•“Ø—á–∏–Ω–≥“Ø–π: <span id="invalidCount" class="bad">0</span></div>
        </div>

        <div class="progress-bar">
          <div class="progress" id="progress" style="width: 0%"></div>
        </div>
      </div>

      <div class="word" id="word">–ë—ç–ª—ç–Ω –±–æ–ª—Å–æ–Ω —É—É?</div>

      <div class="section">
        <div class="row">
          <button id="btnI">I (—ç–µ—Ä—ç–≥)</button>
          <button id="btnE">E (—Å”©—Ä”©–≥)</button>
        </div>

        <div class="row">
          <button id="btnUndo">–°“Ø“Ø–ª—á–∏–π–Ω —Ö–∞—Ä–∏—É–ª—Ç—ã–≥ –±—É—Ü–∞–∞—Ö</button>
          <button id="btnFinish">–¢—É—Ä—à–∏–ª—Ç—ã–≥ –¥—É—É—Å–≥–∞—Ö</button>
        </div>
      </div>
    </div>

    <div id="result" class="hidden">
      <h2 style="text-align: center; margin-bottom: 24px;">“Æ—Ä –¥“Ø–Ω</h2>

      <div class="section">
        <div id="summary"></div>
      </div>

      <div class="section">
        <h3 style="margin-top: 0;">“Æ—Ä –¥“Ø–Ω–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö</h3>
        <div class="row">
          <button id="btnDownloadCsv">CSV —Ñ–∞–π–ª —Ç–∞—Ç–∞—Ö</button>
        </div>

        <div id="status" style="margin-top: 12px; padding: 10px; border-radius: 6px;" class="hidden"></div>
      </div>

      <div class="section">
        <h3>–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª</h3>
        <label class="small">Debug JSON:</label>
        <textarea id="debug"></textarea>
      </div>
    </div>
  </div>

<script>
  // ===== 1) –¢–æ—Ö–∏—Ä–≥–æ–æ / “Æ–≥–∏–π–Ω –±–∞–≥—Ü =====
  const WORDS = [
    "Happy","Sad","Love","Anger","Peace","Hate","Proud","Shame","Smile","Fear",
    "Joy","Pain","Friend","Enemy","Warm","Cold"
  ];
  const SHUFFLE = true; // “Æ–≥–∏–π–≥ —ç—Ö–ª—ç—Ö—ç–¥ —Ö–æ–ª–∏—Ö —ç—Å—ç—Ö
  const SAME_KEY_SPAM_WINDOW = 5;  // –¥–∞—Ä–∞–∞–ª–∞–Ω 5 —É–¥–∞–∞ –∞–¥–∏–ª —Ç–æ–≤—á –¥–∞—Ä—Å–∞–Ω –±–æ–ª ‚Ä¶
  const SAME_KEY_SPAM_RT = 250;    // —Ç—É—Ö–∞–π–Ω 5-–Ω –¥—É–Ω–¥–∞–∂ < 250ms –±–æ–ª spam –≥—ç–∂ —Ç—ç–º–¥—ç–≥–ª—ç–Ω—ç

  // –ê–≤—Ç–æ–º–∞—Ç –∏–º—ç–π–ª–∏–π–Ω endpoint (Google Apps Script Web App URL)
  const AUTO_EMAIL_ENDPOINT = "https://script.google.com/macros/s/AKfycbyabOqbrxqIXXE_gI0W-ykvOJY1zSLAZr4s3NegM054vn4RIcfJMpY2CgB8JDJReG0z/exec";

  // ===== 2) –¢”©–ª”©–≤ =====
  let seq = [];
  let i = 0;
  let startTime = 0;
  let records = [];     // –±“Ø—Ö raw –º”©—Ä“Ø“Ø–¥
  let minValidRt = 200; // UI-—Å –∞–≤–Ω–∞
  let participant = "";

  // spam —à–∞–ª–≥–∞–ª—Ç–∞–¥ —Ç—É—Å–ª–∞—Ö
  let lastAnswers = [];   // —Å“Ø“Ø–ª–∏–π–Ω n —Ç–æ–≤—á–Ω—ã "I" / "E"
  let lastRTs = [];       // —Å“Ø“Ø–ª–∏–π–Ω n RT

  // ===== 3) –≠–ª–µ–º–µ–Ω—Ç–∏–π–Ω —Ö–æ–ª–±–æ–æ—Å =====
  const elSetup = document.getElementById('setup');
  const elStage = document.getElementById('stage');
  const elResult = document.getElementById('result');
  const elWord = document.getElementById('word');
  const elIdx = document.getElementById('idx');
  const elTotal = document.getElementById('total');
  const elValid = document.getElementById('validCount');
  const elInvalid = document.getElementById('invalidCount');
  const elSummary = document.getElementById('summary');
  const elDebug = document.getElementById('debug');
  const elStatus = document.getElementById('status');
  const elProgress = document.getElementById('progress');

  // ===== 4) –¢—É—Å–ª–∞—Ö —Ñ—É–Ω–∫—Ü—É—É–¥ =====
  function shuffle(a) {
    for (let j = a.length - 1; j > 0; j--) {
      const k = Math.floor(Math.random() * (j + 1));
      [a[j], a[k]] = [a[k], a[j]];
    }
    return a;
  }

  function nowTs() {
    return new Date().toISOString();
  }

  function pushAnswer(answer, rt) {
    // window spam —à–∞–ª–≥–∞–ª—Ç
    lastAnswers.push(answer);
    lastRTs.push(rt);
    if (lastAnswers.length > SAME_KEY_SPAM_WINDOW) {
      lastAnswers.shift(); lastRTs.shift();
    }
    let spamSeries = false;
    if (lastAnswers.length === SAME_KEY_SPAM_WINDOW) {
      const allSame = lastAnswers.every(v => v === lastAnswers[0]);
      const avgRt = lastRTs.reduce((a,b)=>a+b,0)/lastRTs.length;
      if (allSame && avgRt < SAME_KEY_SPAM_RT) spamSeries = true;
    }
    const invalid = (rt < minValidRt) || spamSeries;

    records.push({
      idx: i+1,
      word: seq[i],
      answer,
      rt_ms: rt,
      ts: nowTs(),
      participant,
      valid: !invalid,
      reason: invalid ? (rt < minValidRt ? `too_fast_${rt}ms` : 'spam_series') : ''
    });
  }

  function updateCounters() {
    const validN = records.filter(r => r.valid).length;
    const invalidN = records.length - validN;
    elValid.textContent = validN;
    elInvalid.textContent = invalidN;
    elIdx.textContent = Math.min(records.length + 1, seq.length);

    // Progress bar —à–∏–Ω—ç—á–ª—ç—Ö
    const progress = (records.length / seq.length) * 100;
    elProgress.style.width = `${progress}%`;
  }

  function toCSV(rows) {
    const cols = ["idx","word","answer","rt_ms","ts","participant","valid","reason"];
    const header = cols.join(",");
    const body = rows.map(r => cols.map(c => {
      const v = r[c];
      const s = String(v ?? "");
      return `"${s.replace(/"/g,'""')}"`;
    }).join(",")).join("\n");
    return header + "\n" + body;
  }

  function downloadFile(name, content, mime="text/csv") {
    const blob = new Blob([content], {type: mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function showStatus(message, type = "info") {
    elStatus.textContent = message;
    elStatus.className = "";

    if (type === "success") {
      elStatus.style.backgroundColor = "rgba(93, 228, 169, 0.2)";
      elStatus.style.borderLeft = "4px solid var(--success)";
    } else if (type === "error") {
      elStatus.style.backgroundColor = "rgba(255, 139, 139, 0.2)";
      elStatus.style.borderLeft = "4px solid var(--danger)";
    } else {
      elStatus.style.backgroundColor = "rgba(255, 202, 122, 0.2)";
      elStatus.style.borderLeft = "4px solid var(--warning)";
    }

    elStatus.classList.remove("hidden");

    // 5 —Å–µ–∫—É–Ω–¥—ã–Ω –¥–∞—Ä–∞–∞ –º—ç–¥—ç—ç–ª–ª–∏–π–≥ –∞—Ä–∏–ª–≥–∞—Ö
    if (type === "success" || type === "error") {
      setTimeout(() => {
        elStatus.classList.add("hidden");
      }, 5000);
    }
  }

  // –ê–≤—Ç–æ–º–∞—Ç –∏–º—ç–π–ª –∏–ª–≥—ç—ç—Ö —Ñ—É–Ω–∫—Ü
  async function sendAutoEmail(payload) {
    try {
      showStatus("üìß “Æ—Ä –¥“Ø–Ω–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –∏–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞...", "info");

      const res = await fetch(AUTO_EMAIL_ENDPOINT, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
        mode: 'no-cors'  // CORS –∞—Å—É—É–¥–ª—ã–≥ —à–∏–π–¥—ç—Ö–∏–π–Ω —Ç—É–ª–¥
      });

      // no-cors mode-–¥ response status —à–∞–ª–≥–∞–∂ –±–æ–ª–æ—Ö–≥“Ø–π —Ç—É–ª –∞–º–∂–∏–ª—Ç—Ç–∞–π –≥—ç–∂ —Ç–æ–æ—Ü–Ω–æ
      showStatus("‚úÖ “Æ—Ä –¥“Ø–Ω –∞–º–∂–∏–ª—Ç—Ç–∞–π amarmarker@gmail.com —Ä—É—É –∏–ª–≥—ç—ç–≥–¥–ª—ç—ç!", "success");

    } catch (error) {
      console.error('Auto email error:', error);
      showStatus("‚ùå –ê–≤—Ç–æ–º–∞—Ç –∏–º—ç–π–ª –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: " + error.message, "error");
    }
  }

  // ===== 5) –£—Ä—Å–≥–∞–ª =====
  document.getElementById('btnStart').addEventListener('click', () => {
    participant = document.getElementById('participant').value.trim();
    minValidRt = parseInt(document.getElementById('minRt').value || "200", 10);

    if (!participant) {
      showStatus("‚ö†Ô∏è –û—Ä–æ–ª—Ü–æ–≥—á–∏–π–Ω –Ω—ç—Ä —ç—Å–≤—ç–ª ID –æ—Ä—É—É–ª–Ω–∞ —É—É.", "error");
      return;
    }

    if (minValidRt < 100) {
      showStatus("‚ö†Ô∏è Anti-spam –±–æ—Å–≥–æ —Ö—ç—Ç –±–∞–≥–∞ –±–∞–π–Ω–∞. –î–∞—Ä–∞–ª—Ç—ã–Ω —Ö—É—Ä–¥—ã–≥ —Ö—ç–º–∂–∏—Ö—ç–¥ –∞—Å—É—É–¥–∞–ª –≥–∞—Ä—á –±–æ–ª–∑–æ—à–≥“Ø–π.", "error");
      return;
    }

    seq = [...WORDS];
    if (SHUFFLE) shuffle(seq);

    i = 0; records = []; lastAnswers = []; lastRTs = [];
    elTotal.textContent = seq.length;
    elSetup.classList.add('hidden');
    elStage.classList.remove('hidden');

    // 3 —Å–µ–∫—É–Ω–¥—ã–Ω –¥–∞—Ä–∞–∞ —ç—Ö–Ω–∏–π “Ø–≥–∏–π–≥ —Ö–∞—Ä—É—É–ª–∞—Ö
    elWord.textContent = "3";
    setTimeout(() => {
      elWord.textContent = "2";
      setTimeout(() => {
        elWord.textContent = "1";
        setTimeout(() => {
          showWord();
        }, 1000);
      }, 1000);
    }, 1000);
  });

  function showWord() {
    if (i >= seq.length) return finish();
    elWord.textContent = seq[i];
    startTime = performance.now();
    updateCounters();
  }

  function answer(a) {
    const rt = Math.round(performance.now() - startTime);
    pushAnswer(a, rt);
    i++;
    if (i < seq.length) showWord(); else finish();
  }

  document.getElementById('btnI').addEventListener('click', ()=>answer('I'));
  document.getElementById('btnE').addEventListener('click', ()=>answer('E'));

  document.getElementById('btnUndo').addEventListener('click', () => {
    if (!records.length) {
      showStatus("–ë—É—Ü–∞–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π —Ö–∞—Ä–∏—É–ª—Ç –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.", "error");
      return;
    }
    records.pop();
    i = Math.max(0, i - 1);
    lastAnswers.pop();
    lastRTs.pop();
    showWord();
    showStatus("–°“Ø“Ø–ª—á–∏–π–Ω —Ö–∞—Ä–∏—É–ª—Ç—ã–≥ –∞–º–∂–∏–ª—Ç—Ç–∞–π –±—É—Ü–∞–∞–≤.", "success");
  });

  document.getElementById('btnFinish').addEventListener('click', () => {
    if (records.length < seq.length) {
      if (confirm("–¢—É—Ä—à–∏–ª—Ç –¥—É—É—Å–∞–∞–≥“Ø–π –±–∞–π–Ω–∞. –î—É—É—Å–≥–∞—Ö —É—É?")) {
        finish();
      }
    } else {
      finish();
    }
  });

  function finish() {
    elStage.classList.add('hidden');
    elResult.classList.remove('hidden');

    const validRows = records.filter(r => r.valid);
    const avgI = average(validRows.filter(r => r.answer === 'I').map(r=>r.rt_ms));
    const avgE = average(validRows.filter(r => r.answer === 'E').map(r=>r.rt_ms));

    const totalTime = validRows.reduce((sum, r) => sum + r.rt_ms, 0);

    elSummary.innerHTML = `
      <div class="result-item">
        <div>–ù–∏–π—Ç —Ö–∞—Ä–∏—É–ª—Ç:</div>
        <div class="result-value">${records.length}</div>
      </div>
      <div class="result-item">
        <div>–•“Ø—á–∏–Ω—Ç—ç–π —Ö–∞—Ä–∏—É–ª—Ç:</div>
        <div class="result-value ok">${validRows.length}</div>
      </div>
      <div class="result-item">
        <div>–•“Ø—á–∏–Ω–≥“Ø–π —Ö–∞—Ä–∏—É–ª—Ç:</div>
        <div class="result-value bad">${records.length - validRows.length}</div>
      </div>
      <div class="result-item">
        <div>I (—ç–µ—Ä—ç–≥) –¥—É–Ω–¥–∞–∂ RT:</div>
        <div class="result-value">${isFinite(avgI)?Math.round(avgI):'-'} ms</div>
      </div>
      <div class="result-item">
        <div>E (—Å”©—Ä”©–≥) –¥—É–Ω–¥–∞–∂ RT:</div>
        <div class="result-value">${isFinite(avgE)?Math.round(avgE):'-'} ms</div>
      </div>
      <div class="result-item">
        <div>–ù–∏–π—Ç –∑–∞—Ä—Ü—É—É–ª—Å–∞–Ω —Ö—É–≥–∞—Ü–∞–∞:</div>
        <div class="result-value">${Math.round(totalTime/1000)} —Å–µ–∫—É–Ω–¥</div>
      </div>
    `;

    const payload = {
      meta: {
        generated_at: nowTs(),
        participant,
        min_valid_rt_ms: minValidRt,
        same_key_spam_window: SAME_KEY_SPAM_WINDOW,
        same_key_spam_rt_ms: SAME_KEY_SPAM_RT,
        total: records.length,
        valid: validRows.length,
        invalid: records.length - validRows.length,
        avg_rt_I: avgI,
        avg_rt_E: avgE,
        total_time_ms: totalTime
      },
      rows: records,
      csv_data: toCSV(records)
    };

    elDebug.value = JSON.stringify(payload, null, 2);

    // –ê–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –∏–º—ç–π–ª –∏–ª–≥—ç—ç—Ö
    sendAutoEmail(payload);

    // CSV —Ç–∞—Ç–∞—Ö —Ç–æ–≤—á
    document.getElementById('btnDownloadCsv').onclick = () => {
      const csv = toCSV(records);
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      const filename = `ie_test_${participant.replace(/[^a-zA-Z0-9]/g, '_')}_${timestamp}.csv`;
      downloadFile(filename, csv, "text/csv");
      showStatus("CSV —Ñ–∞–π–ª –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ç–∞—Ç–∞–≥–¥–ª–∞–∞.", "success");
    };
  }

  function average(a) {
    if (!a.length) return NaN;
    return a.reduce((x,y)=>x+y,0)/a.length;
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (elStage.classList.contains('hidden')) return;

    if (e.key === 'i' || e.key === 'I') {
      document.getElementById('btnI').click();
      document.getElementById('btnI').style.transform = 'scale(0.95)';
      setTimeout(() => {
        document.getElementById('btnI').style.transform = '';
      }, 150);
    } else if (e.key === 'e' || e.key === 'E') {
      document.getElementById('btnE').click();
      document.getElementById('btnE').style.transform = 'scale(0.95)';
      setTimeout(() => {
        document.getElementById('btnE').style.transform = '';
      }, 150);
    } else if (e.key === 'z' && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      document.getElementById('btnUndo').click();
    }
  });
</script>
</body>
</html>
