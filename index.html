<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <title>I/E Reaction Test - 3 Phase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #0b1220;
      --secondary: #111a2c;
      --accent: #2a395a;
      --text: #eaf0ff;
      --muted: #98a8c9;
      --success: #5de4a9;
      --danger: #ff8b8b;
      --warning: #ffca7a;
    }

    * {
      box-sizing: border-box;
      transition: all 0.2s ease;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100svh;
      margin: 0;
      background: linear-gradient(135deg, var(--primary) 0%, #1a2a4f 100%);
      color: var(--text);
      line-height: 1.6;
    }

    .card {
      width: min(720px, 92vw);
      background: var(--secondary);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(42, 57, 90, 0.3);
    }

    h1 {
      margin: 0 0 8px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--text) 0%, var(--muted) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
    }

    h2, h3 {
      color: var(--text);
      text-align: center;
    }

    .subtitle {
      color: var(--muted);
      font-size: 16px;
      margin-bottom: 24px;
      text-align: center;
    }

    .phase-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--success);
      text-align: center;
      margin-bottom: 16px;
    }

    .stimulus-area {
      min-height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 0;
      gap: 20px;
    }

    .word {
      font-size: clamp(32px, 7vw, 56px);
      text-align: center;
      letter-spacing: .5px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--text) 0%, var(--muted) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .image {
      max-width: 200px;
      max-height: 200px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      object-fit: cover;
    }

    .row {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      font-size: 18px;
      padding: 16px 24px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--accent) 0%, #1c2a48 100%);
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      flex: 1;
      min-width: 140px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #btnI {
      background: linear-gradient(135deg, var(--success) 0%, #4ac295 100%);
    }

    #btnE {
      background: linear-gradient(135deg, var(--danger) 0%, #e57373 100%);
    }

    .pill {
      font-size: 14px;
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill span {
      font-weight: 600;
      color: var(--text);
    }

    .ok { color: var(--success); }
    .bad { color: var(--danger); }
    .warn { color: var(--warning); }

    .hidden { display: none; }

    textarea, input, select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--accent);
      background: rgba(15, 24, 48, 0.6);
      color: var(--text);
      font-size: 16px;
    }

    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: #3a4d7a;
      box-shadow: 0 0 0 2px rgba(58, 77, 122, 0.3);
    }

    .small {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 6px;
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .section {
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(42, 57, 90, 0.3);
    }

    .section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .progress-bar {
      height: 8px;
      background: rgba(42, 57, 90, 0.3);
      border-radius: 4px;
      margin: 16px 0;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--success) 0%, #4ac295 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .instructions {
      background: rgba(42, 57, 90, 0.2);
      padding: 16px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid var(--accent);
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(42, 57, 90, 0.2);
    }

    .result-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .result-value {
      font-weight: 600;
    }

    .auto-email-info {
      background: rgba(93, 228, 169, 0.1);
      border: 1px solid rgba(93, 228, 169, 0.3);
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
      color: var(--success);
    }

    .question-group {
      background: rgba(42, 57, 90, 0.1);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
      border-left: 4px solid var(--accent);
    }

    .likert-scale {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0;
      gap: 8px;
    }

    .likert-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 60px;
    }

    .likert-option input[type="radio"] {
      width: 20px;
      height: 20px;
      margin: 0;
    }

    .likert-label {
      font-size: 12px;
      text-align: center;
      color: var(--muted);
    }

    .required {
      color: var(--danger);
    }

    .phase-break {
      background: rgba(93, 228, 169, 0.1);
      border: 2px solid var(--success);
      border-radius: 15px;
      padding: 24px;
      text-align: center;
      margin: 20px 0;
    }

    .phase-break h3 {
      color: var(--success);
      margin: 0 0 16px 0;
    }

    @media (max-width: 640px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .card {
        padding: 24px 20px;
      }

      button {
        min-width: 100%;
      }

      .likert-scale {
        flex-direction: column;
        gap: 12px;
      }

      .likert-option {
        flex-direction: row;
        min-width: auto;
        width: 100%;
        justify-content: space-between;
        padding: 8px;
        background: rgba(42, 57, 90, 0.2);
        border-radius: 8px;
      }

      .stimulus-area {
        min-height: 250px;
        padding: 30px 0;
      }

      .image {
        max-width: 150px;
        max-height: 150px;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>I / E Reaction Test - 3 —Ö—ç—Å—ç–≥</h1>
    <div class="subtitle">3 ”©”©—Ä —Ö—ç–ª–±—ç—Ä–∏–π–Ω —Ç–µ—Å—Ç—ç—ç—Ä –¥–∞–º–∂–∏–Ω —ç–µ—Ä—ç–≥/—Å”©—Ä”©–≥ —Ö–∞—Ä–∏—É ”©–≥–Ω”© “Ø“Ø.</div>

    <!-- Setup -->
    <div id="setup">
      <div class="section">
        <div>
          <label class="small">–û—Ä–æ–ª—Ü–æ–≥—á–∏–π–Ω ID / –ù—ç—Ä <span class="required">*</span>:</label>
          <input id="participant" placeholder="–ñ–∏—à—ç—ç: –ë.–ë–∞—Ç–±–∞—è—Ä" required>
        </div>
        <!-- Anti-spam –±–æ—Å–≥–æ –¥–∞–ª–¥–ª–∞–≥–¥—Å–∞–Ω, –≥—ç—Ö–¥—ç—ç –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–Ω–∞ -->
        <input id="minRt" type="hidden" value="200">
      </div>

      <div class="question-group">
        <label class="small">–¢–∞–Ω—ã –æ–¥–æ–æ–≥–∏–π–Ω —Å—ç—Ç–≥—ç–ª —Å–∞–Ω–∞–∞–Ω—ã —Ç”©–ª”©–≤ —Ö—ç—Ä—Ö—ç–Ω –±–∞–π–Ω–∞?</label>
        <div class="likert-scale">
          <div class="likert-option">
            <input type="radio" name="mood" value="1" id="mood1">
            <label for="mood1" class="likert-label">–ú–∞—à –º—É—É</label>
          </div>
          <div class="likert-option">
            <input type="radio" name="mood" value="2" id="mood2">
            <label for="mood2" class="likert-label">–ú—É—É</label>
          </div>
          <div class="likert-option">
            <input type="radio" name="mood" value="3" id="mood3">
            <label for="mood3" class="likert-label">–î—É–Ω–¥ –∑—ç—Ä—ç–≥</label>
          </div>
          <div class="likert-option">
            <input type="radio" name="mood" value="4" id="mood4">
            <label for="mood4" class="likert-label">–°–∞–π–Ω</label>
          </div>
          <div class="likert-option">
            <input type="radio" name="mood" value="5" id="mood5">
            <label for="mood5" class="likert-label">–ú–∞—à —Å–∞–π–Ω</label>
          </div>
        </div>
      </div>



      <div class="instructions">
        <strong>–ó–∞–∞–≤–∞—Ä:</strong>
        <ul style="margin: 8px 0; padding-left: 20px;">
          <li><strong>1-—Ä —Ö—ç—Å—ç–≥:</strong> “Æ–≥ —Ö–∞—Ä–∂ "I" (—ç–µ—Ä—ç–≥) —ç—Å–≤—ç–ª "E" (—Å”©—Ä”©–≥) –¥–∞—Ä–Ω–∞</li>
          <li><strong>2-—Ä —Ö—ç—Å—ç–≥:</strong> –ó—É—Ä–∞–≥ —Ö–∞—Ä–∂ "I" (—ç–µ—Ä—ç–≥) —ç—Å–≤—ç–ª "E" (—Å”©—Ä”©–≥) –¥–∞—Ä–Ω–∞</li>
          <li><strong>3-—Ä —Ö—ç—Å—ç–≥:</strong> –ó—É—Ä–∞–≥ + “Ø–≥ —Ö–æ—Å–ª–æ–ª —Ö–∞—Ä–∂ "I" (—ç–µ—Ä—ç–≥) —ç—Å–≤—ç–ª "E" (—Å”©—Ä”©–≥) –¥–∞—Ä–Ω–∞</li>
          <li>–•—ç—Ç —Ö—É—Ä–¥–∞–Ω —Ö–∞—Ä–∏—É–ª—Ç—ã–≥ (200ms-—ç—ç—Å –±–∞–≥–∞) —Ç–æ–æ—Ü–æ—Ö–≥“Ø–π</li>
          <li>–ê–ª—å –±–æ–ª–æ—Ö —Ö—É—Ä–¥–∞–Ω, –∑”©–≤ —Ö–∞—Ä–∏—É–ª–∞—Ö—ã–≥ —Ö–∏—á—ç—ç–≥—ç—ç—Ä—ç–π</li>
        </ul>
      </div>

      <div class="row">
        <button id="btnStart">–¢—É—Ä—à–∏–ª—Ç—ã–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö</button>
      </div>
    </div>

    <!-- Test Stage -->
    <div id="stage" class="hidden">
      <div class="phase-title" id="phaseTitle">1-—Ä —Ö—ç—Å—ç–≥: “Æ–≥</div>
      
      <div class="section">
        <div class="row">
          <div class="pill">–•—ç—Å—ç–≥: <span id="currentPhase">1</span>/3</div>
          <div class="pill">“Æ–≥: <span id="idx">0</span>/<span id="total">0</span></div>
          <div class="pill">–•“Ø—á–∏–Ω—Ç—ç–π: <span id="validCount" class="ok">0</span></div>
          <div class="pill">–•“Ø—á–∏–Ω–≥“Ø–π: <span id="invalidCount" class="bad">0</span></div>
        </div>

        <div class="progress-bar">
          <div class="progress" id="progress" style="width: 0%"></div>
        </div>
      </div>

      <div class="stimulus-area" id="stimulusArea">
        <div class="word" id="word">–ë—ç–ª—ç–Ω –±–æ–ª—Å–æ–Ω —É—É?</div>
        <img id="image" class="image hidden" src="" alt="">
      </div>

      <div class="section">
        <div class="row">
          <button id="btnI">I (—ç–µ—Ä—ç–≥)</button>
          <button id="btnE">E (—Å”©—Ä”©–≥)</button>
        </div>

        <div class="row">
          <button id="btnUndo">–°“Ø“Ø–ª—á–∏–π–Ω —Ö–∞—Ä–∏—É–ª—Ç—ã–≥ –±—É—Ü–∞–∞—Ö</button>
          <button id="btnFinish">–¢—É—Ä—à–∏–ª—Ç—ã–≥ –¥—É—É—Å–≥–∞—Ö</button>
        </div>
      </div>
    </div>

    <!-- Phase Break -->
    <div id="phaseBreak" class="hidden">
      <div class="phase-break">
        <h3 id="breakTitle">1-—Ä —Ö—ç—Å—ç–≥ –¥—É—É—Å–ª–∞–∞!</h3>
        <p id="breakMessage">2-—Ä —Ö—ç—Å—ç–≥—Ç –∑—É—Ä–∞–≥ —Ö–∞—Ä–∂ —Ö–∞—Ä–∏—É–ª–Ω–∞.</p>
        <button id="btnNextPhase">–î–∞—Ä–∞–∞–≥–∏–π–Ω —Ö—ç—Å—ç–≥ —Ä“Ø“Ø</button>
      </div>
    </div>

    <!-- Results -->
    <div id="result" class="hidden">
      <h2 style="text-align: center; margin-bottom: 24px;">“Æ—Ä –¥“Ø–Ω</h2>

      <div class="section">
        <div id="summary"></div>
      </div>

      <div class="section">
        <h3 style="margin-top: 0;">“Æ—Ä –¥“Ø–Ω–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö</h3>
        <div class="row">
          <button id="btnDownloadCsv">CSV —Ñ–∞–π–ª —Ç–∞—Ç–∞—Ö</button>
        </div>

        <div id="status" style="margin-top: 12px; padding: 10px; border-radius: 6px;" class="hidden"></div>
      </div>

      <div class="section">
        <h3>–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª</h3>
        <label class="small">Debug JSON:</label>
        <textarea id="debug"></textarea>
      </div>
    </div>
  </div>

<script>
  // ===== 1) –¢–æ—Ö–∏—Ä–≥–æ–æ =====
  const WORDS = [
    "Happy","Sad","Love","Anger","Peace","Hate","Proud","Shame","Smile","Fear",
    "Joy","Pain","Friend","Enemy","Warm","Cold"
  ];

  // –ó—É—Ä–≥–∏–π–Ω URLs (placeholder images - —Ç–∞ ”©”©—Ä—á–∏–ª–∂ –±–æ–ª–Ω–æ)
  const IMAGES = [
    "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=200&h=200&fit=crop", // happy
    "https://images.unsplash.com/photo-1551601651-2a8555f1a136?w=200&h=200&fit=crop", // sad
    "https://images.unsplash.com/photo-1518199266791-5375a83190b7?w=200&h=200&fit=crop", // love
    "https://images.unsplash.com/photo-1621252179027-94459d278660?w=200&h=200&fit=crop", // anger
    "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=200&h=200&fit=crop", // peace
    "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=200&h=200&fit=crop", // hate
    "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200&h=200&fit=crop", // proud
    "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=200&h=200&fit=crop", // shame
    "https://images.unsplash.com/photo-1464207687429-7505649dae38?w=200&h=200&fit=crop", // smile
    "https://images.unsplash.com/photo-1614850523060-8da21d432f29?w=200&h=200&fit=crop", // fear
    "https://images.unsplash.com/photo-1513475382585-d06e58bcb0e0?w=200&h=200&fit=crop", // joy
    "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=200&h=200&fit=crop", // pain
    "https://images.unsplash.com/photo-1521737711867-e3b97375f902?w=200&h=200&fit=crop", // friend
    "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=200&h=200&fit=crop", // enemy
    "https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=200&h=200&fit=crop", // warm
    "https://images.unsplash.com/photo-1483664852095-d6cc6870702d?w=200&h=200&fit=crop"  // cold
  ];

  const PHASES = [
    { name: "1-—Ä —Ö—ç—Å—ç–≥: “Æ–≥", type: "word" },
    { name: "2-—Ä —Ö—ç—Å—ç–≥: –ó—É—Ä–∞–≥", type: "image" },
    { name: "3-—Ä —Ö—ç—Å—ç–≥: “Æ–≥ + –ó—É—Ä–∞–≥", type: "both" }
  ];

  const SHUFFLE = true;
  const SAME_KEY_SPAM_WINDOW = 5;
  const SAME_KEY_SPAM_RT = 250;

  const AUTO_EMAIL_ENDPOINT = "https://script.google.com/macros/s/AKfycbyabOqbrxqIXXE_gI0W-ykvOJY1zSLAZr4s3NegM054vn4RIcfJMpY2CgB8JDJReG0z/exec";

  // ===== 2) –¢”©–ª”©–≤ =====
  let currentPhase = 0;
  let seq = [];
  let imageSeq = [];
  let i = 0;
  let startTime = 0;
  let records = [];
  let minValidRt = 200;
  let participantData = {};

  let lastAnswers = [];
  let lastRTs = [];

  // ===== 3) –≠–ª–µ–º–µ–Ω—Ç–∏–π–Ω —Ö–æ–ª–±–æ–æ—Å =====
  const elSetup = document.getElementById('setup');
  const elStage = document.getElementById('stage');
  const elPhaseBreak = document.getElementById('phaseBreak');
  const elResult = document.getElementById('result');
  const elWord = document.getElementById('word');
  const elImage = document.getElementById('image');
  const elIdx = document.getElementById('idx');
  const elTotal = document.getElementById('total');
  const elValid = document.getElementById('validCount');
  const elInvalid = document.getElementById('invalidCount');
  const elSummary = document.getElementById('summary');
  const elDebug = document.getElementById('debug');
  const elStatus = document.getElementById('status');
  const elProgress = document.getElementById('progress');
  const elPhaseTitle = document.getElementById('phaseTitle');
  const elCurrentPhase = document.getElementById('currentPhase');

  // ===== 4) –¢—É—Å–ª–∞—Ö —Ñ—É–Ω–∫—Ü—É—É–¥ =====
  function shuffle(a) {
    for (let j = a.length - 1; j > 0; j--) {
      const k = Math.floor(Math.random() * (j + 1));
      [a[j], a[k]] = [a[k], a[j]];
    }
    return a;
  }

  function nowTs() {
    return new Date().toISOString();
  }

  function getFormData(formId) {
    const data = {};
    const form = document.getElementById(formId) || document;
    
    form.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.type === 'radio') {
        if (el.checked) data[el.name] = el.value;
      } else if (el.id && el.value !== '') {
        data[el.id] = el.value;
      }
    });
    
    return data;
  }

  function pushAnswer(answer, rt) {
    lastAnswers.push(answer);
    lastRTs.push(rt);
    if (lastAnswers.length > SAME_KEY_SPAM_WINDOW) {
      lastAnswers.shift(); lastRTs.shift();
    }
    let spamSeries = false;
    if (lastAnswers.length === SAME_KEY_SPAM_WINDOW) {
      const allSame = lastAnswers.every(v => v === lastAnswers[0]);
      const avgRt = lastRTs.reduce((a,b)=>a+b,0)/lastRTs.length;
      if (allSame && avgRt < SAME_KEY_SPAM_RT) spamSeries = true;
    }
    const invalid = (rt < minValidRt) || spamSeries;

    records.push({
      idx: i+1,
      phase: currentPhase + 1,
      phase_type: PHASES[currentPhase].type,
      word: seq[i] || '',
      image: imageSeq[i] || '',
      answer,
      rt_ms: rt,
      ts: nowTs(),
      participant: participantData.participant || '',
      valid: !invalid,
      reason: invalid ? (rt < minValidRt ? `too_fast_${rt}ms` : 'spam_series') : ''
    });
  }

  function updateCounters() {
    const validN = records.filter(r => r.valid && r.phase === currentPhase + 1).length;
    const invalidN = records.filter(r => r.phase === currentPhase + 1).length - validN;
    elValid.textContent = validN;
    elInvalid.textContent = invalidN;
    elIdx.textContent = Math.min(records.filter(r => r.phase === currentPhase + 1).length + 1, seq.length);
    elCurrentPhase.textContent = currentPhase + 1;

    const progress = (records.filter(r => r.phase === currentPhase + 1).length / seq.length) * 100;
    elProgress.style.width = `${progress}%`;
  }

  function toCSV(rows) {
    const cols = ["idx","phase","phase_type","word","image","answer","rt_ms","ts","participant","valid","reason"];
    const header = cols.join(",");
    const body = rows.map(r => cols.map(c => {
      const v = r[c];
      const s = String(v ?? "");
      return `"${s.replace(/"/g,'""')}"`;
    }).join(",")).join("\n");
    return header + "\n" + body;
  }

  function downloadFile(name, content, mime="text/csv") {
    const blob = new Blob([content], {type: mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function showStatus(message, type = "info") {
    elStatus.textContent = message;
    elStatus.className = "";

    if (type === "success") {
      elStatus.style.backgroundColor = "rgba(93, 228, 169, 0.2)";
      elStatus.style.borderLeft = "4px solid var(--success)";
    } else if (type === "error") {
      elStatus.style.backgroundColor = "rgba(255, 139, 139, 0.2)";
      elStatus.style.borderLeft = "4px solid var(--danger)";
    } else {
      elStatus.style.backgroundColor = "rgba(255, 202, 122, 0.2)";
      elStatus.style.borderLeft = "4px solid var(--warning)";
    }

    elStatus.classList.remove("hidden");

    if (type === "success" || type === "error") {
      setTimeout(() => {
        elStatus.classList.add("hidden");
      }, 5000);
    }
  }

  async function sendAutoEmail(payload) {
    try {
      showStatus("üìß “Æ—Ä –¥“Ø–Ω–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –∏–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞...", "info");

      const res = await fetch(AUTO_EMAIL_ENDPOINT, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
        mode: 'no-cors'
      });

      // no-cors mode-–¥ response status —à–∞–ª–≥–∞–∂ –±–æ–ª–æ—Ö–≥“Ø–π —Ç—É–ª –∞–º–∂–∏–ª—Ç—Ç–∞–π –≥—ç–∂ —Ç–æ–æ—Ü–Ω–æ
      showStatus("‚úÖ “Æ—Ä –¥“Ø–Ω –∞–º–∂–∏–ª—Ç—Ç–∞–π amarmarker@gmail.com —Ä—É—É –∏–ª–≥—ç—ç–≥–¥–ª—ç—ç!", "success");

    } catch (error) {
      console.error('Auto email error:', error);
      showStatus("‚ùå –ê–≤—Ç–æ–º–∞—Ç –∏–º—ç–π–ª –∏–ª–≥—ç—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: " + error.message, "error");
    }
  }

  // ===== 5) Event Handlers =====

  // Start Test Button
  document.getElementById('btnStart').addEventListener('click', () => {
    participantData = getFormData('setup');
    
    if (!participantData.participant) {
      showStatus("‚ö†Ô∏è –û—Ä–æ–ª—Ü–æ–≥—á–∏–π–Ω –Ω—ç—Ä —ç—Å–≤—ç–ª ID –æ—Ä—É—É–ª–Ω–∞ —É—É.", "error");
      return;
    }

    minValidRt = parseInt(participantData.minRt || "200", 10);

    if (minValidRt < 100) {
      showStatus("‚ö†Ô∏è Anti-spam –±–æ—Å–≥–æ —Ö—ç—Ç –±–∞–≥–∞ –±–∞–π–Ω–∞.", "error");
      return;
    }

    // Initialize test
    initializePhase();
  });

  function initializePhase() {
    // Create sequences for current phase
    seq = [...WORDS];
    imageSeq = [...IMAGES];
    
    if (SHUFFLE) {
      const indices = Array.from({length: WORDS.length}, (_, i) => i);
      shuffle(indices);
      seq = indices.map(i => WORDS[i]);
      imageSeq = indices.map(i => IMAGES[i]);
    }

    i = 0;
    elTotal.textContent = seq.length;
    elPhaseTitle.textContent = PHASES[currentPhase].name;
    
    elSetup.classList.add('hidden');
    elPhaseBreak.classList.add('hidden');
    elStage.classList.remove('hidden');

    // Countdown
    elWord.textContent = "3";
    elImage.classList.add('hidden');
    setTimeout(() => {
      elWord.textContent = "2";
      setTimeout(() => {
        elWord.textContent = "1";
        setTimeout(() => {
          showStimulus();
        }, 1000);
      }, 1000);
    }, 1000);
  }

  function showStimulus() {
    if (i >= seq.length) return endPhase();
    
    const phaseType = PHASES[currentPhase].type;
    
    // Reset display
    elWord.classList.add('hidden');
    elImage.classList.add('hidden');
    
    // Show based on phase type
    if (phaseType === 'word') {
      elWord.textContent = seq[i];
      elWord.classList.remove('hidden');
    } else if (phaseType === 'image') {
      elImage.src = imageSeq[i];
      elImage.classList.remove('hidden');
    } else if (phaseType === 'both') {
      elWord.textContent = seq[i];
      elImage.src = imageSeq[i];
      elWord.classList.remove('hidden');
      elImage.classList.remove('hidden');
    }
    
    startTime = performance.now();
    updateCounters();
  }

  function answer(a) {
    const rt = Math.round(performance.now() - startTime);
    pushAnswer(a, rt);
    i++;
    if (i < seq.length) showStimulus(); else endPhase();
  }

  function endPhase() {
    if (currentPhase < PHASES.length - 1) {
      // Show phase break
      elStage.classList.add('hidden');
      elPhaseBreak.classList.remove('hidden');
      
      document.getElementById('breakTitle').textContent = `${currentPhase + 1}-—Ä —Ö—ç—Å—ç–≥ –¥—É—É—Å–ª–∞–∞!`;
      
      if (currentPhase === 0) {
        document.getElementById('breakMessage').textContent = "2-—Ä —Ö—ç—Å—ç–≥—Ç –∑—É—Ä–∞–≥ —Ö–∞—Ä–∂ —Ö–∞—Ä–∏—É–ª–Ω–∞.";
      } else if (currentPhase === 1) {
        document.getElementById('breakMessage').textContent = "3-—Ä —Ö—ç—Å—ç–≥—Ç –∑—É—Ä–∞–≥ + “Ø–≥ —Ö–æ—Å–ª–æ–ª —Ö–∞—Ä–∂ —Ö–∞—Ä–∏—É–ª–Ω–∞.";
      }
    } else {
      // All phases done
      finish();
    }
  }

  // Next Phase Button
  document.getElementById('btnNextPhase').addEventListener('click', () => {
    currentPhase++;
    initializePhase();
  });

  document.getElementById('btnI').addEventListener('click', ()=>answer('I'));
  document.getElementById('btnE').addEventListener('click', ()=>answer('E'));

  document.getElementById('btnUndo').addEventListener('click', () => {
    const currentPhaseRecords = records.filter(r => r.phase === currentPhase + 1);
    if (!currentPhaseRecords.length) {
      showStatus("–ë—É—Ü–∞–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π —Ö–∞—Ä–∏—É–ª—Ç –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.", "error");
      return;
    }
    
    // Remove last record for current phase
    for (let idx = records.length - 1; idx >= 0; idx--) {
      if (records[idx].phase === currentPhase + 1) {
        records.splice(idx, 1);
        break;
      }
    }
    
    i = Math.max(0, i - 1);
    if (lastAnswers.length > 0) lastAnswers.pop();
    if (lastRTs.length > 0) lastRTs.pop();
    showStimulus();
    showStatus("–°“Ø“Ø–ª—á–∏–π–Ω —Ö–∞—Ä–∏—É–ª—Ç—ã–≥ –∞–º–∂–∏–ª—Ç—Ç–∞–π –±—É—Ü–∞–∞–≤.", "success");
  });

  document.getElementById('btnFinish').addEventListener('click', () => {
    if (confirm("–¢—É—Ä—à–∏–ª—Ç—ã–≥ –¥—É—É—Å–≥–∞—Ö —É—É?")) {
      finish();
    }
  });

  function finish() {
    elStage.classList.add('hidden');
    elPhaseBreak.classList.add('hidden');
    elResult.classList.remove('hidden');

    const validRows = records.filter(r => r.valid);
    
    // Calculate stats by phase
    const phaseStats = PHASES.map((phase, idx) => {
      const phaseRecords = validRows.filter(r => r.phase === idx + 1);
      const avgI = average(phaseRecords.filter(r => r.answer === 'I').map(r=>r.rt_ms));
      const avgE = average(phaseRecords.filter(r => r.answer === 'E').map(r=>r.rt_ms));
      
      return {
        phase: idx + 1,
        name: phase.name,
        total: records.filter(r => r.phase === idx + 1).length,
        valid: phaseRecords.length,
        invalid: records.filter(r => r.phase === idx + 1 && !r.valid).length,
        avgI: avgI,
        avgE: avgE
      };
    });

    const totalTime = validRows.reduce((sum, r) => sum + r.rt_ms, 0);

    let summaryHTML = `
      <div class="result-item">
        <div>–ù–∏–π—Ç —Ö–∞—Ä–∏—É–ª—Ç (–±“Ø—Ö —Ö—ç—Å—ç–≥):</div>
        <div class="result-value">${records.length}</div>
      </div>
      <div class="result-item">
        <div>–•“Ø—á–∏–Ω—Ç—ç–π —Ö–∞—Ä–∏—É–ª—Ç (–±“Ø—Ö —Ö—ç—Å—ç–≥):</div>
        <div class="result-value ok">${validRows.length}</div>
      </div>
      <div class="result-item">
        <div>–•“Ø—á–∏–Ω–≥“Ø–π —Ö–∞—Ä–∏—É–ª—Ç (–±“Ø—Ö —Ö—ç—Å—ç–≥):</div>
        <div class="result-value bad">${records.length - validRows.length}</div>
      </div>
      <div class="result-item">
        <div>–ù–∏–π—Ç –∑–∞—Ä—Ü—É—É–ª—Å–∞–Ω —Ö—É–≥–∞—Ü–∞–∞:</div>
        <div class="result-value">${Math.round(totalTime/1000)} —Å–µ–∫—É–Ω–¥</div>
      </div>
    `;

    // Add phase-specific stats
    phaseStats.forEach(stat => {
      summaryHTML += `
        <div class="result-item" style="margin-top: 20px; border-top: 2px solid var(--accent); padding-top: 12px;">
          <div><strong>${stat.name}</strong></div>
          <div></div>
        </div>
        <div class="result-item">
          <div>–ù–∏–π—Ç —Ö–∞—Ä–∏—É–ª—Ç:</div>
          <div class="result-value">${stat.total}</div>
        </div>
        <div class="result-item">
          <div>–•“Ø—á–∏–Ω—Ç—ç–π —Ö–∞—Ä–∏—É–ª—Ç:</div>
          <div class="result-value ok">${stat.valid}</div>
        </div>
        <div class="result-item">
          <div>I (—ç–µ—Ä—ç–≥) –¥—É–Ω–¥–∞–∂ RT:</div>
          <div class="result-value">${isFinite(stat.avgI)?Math.round(stat.avgI):'-'} ms</div>
        </div>
        <div class="result-item">
          <div>E (—Å”©—Ä”©–≥) –¥—É–Ω–¥–∞–∂ RT:</div>
          <div class="result-value">${isFinite(stat.avgE)?Math.round(stat.avgE):'-'} ms</div>
        </div>
      `;
    });

    elSummary.innerHTML = summaryHTML;

    const payload = {
      meta: {
        generated_at: nowTs(),
        participant: participantData.participant,
        min_valid_rt_ms: minValidRt,
        same_key_spam_window: SAME_KEY_SPAM_WINDOW,
        same_key_spam_rt_ms: SAME_KEY_SPAM_RT,
        total_records: records.length,
        total_valid: validRows.length,
        total_invalid: records.length - validRows.length,
        total_time_ms: totalTime,
        phases: phaseStats
      },
      participant_data: participantData,
      test_records: records,
      csv_data: toCSV(records)
    };

    elDebug.value = JSON.stringify(payload, null, 2);

    // Send auto email
    sendAutoEmail(payload);

    // CSV download
    document.getElementById('btnDownloadCsv').onclick = () => {
      const csv = toCSV(records);
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      const filename = `ie_test_3phase_${participantData.participant.replace(/[^a-zA-Z0-9]/g, '_')}_${timestamp}.csv`;
      downloadFile(filename, csv, "text/csv");
      showStatus("CSV —Ñ–∞–π–ª –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ç–∞—Ç–∞–≥–¥–ª–∞–∞.", "success");
    };
  }

  function average(a) {
    if (!a.length) return NaN;
    return a.reduce((x,y)=>x+y,0)/a.length;
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (elStage.classList.contains('hidden')) return;

    if (e.key === 'i' || e.key === 'I') {
      document.getElementById('btnI').click();
      document.getElementById('btnI').style.transform = 'scale(0.95)';
      setTimeout(() => {
        document.getElementById('btnI').style.transform = '';
      }, 150);
    } else if (e.key === 'e' || e.key === 'E') {
      document.getElementById('btnE').click();
      document.getElementById('btnE').style.transform = 'scale(0.95)';
      setTimeout(() => {
        document.getElementById('btnE').style.transform = '';
      }, 150);
    } else if (e.key === 'z' && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      document.getElementById('btnUndo').click();
    }
  });
</script>
</body>
</html>
